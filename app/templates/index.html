{% extends "base.html" %}

{% block header_left %}
<!-- Hamburger Menu -->
<button @click="showSidebar = true"
    class="text-amber hover:text-white text-2xl md:text-3xl font-bold px-1 md:px-2 focus:outline-none">
    ☰
</button>
{% endblock %}

{% block terminal_path %}
<!-- TODO: Make path clickable for navigation (e.g., click on category to go to category root) -->
<!-- TODO: Add password change modal when clicking on username in path -->
<!-- TODO: Implement multilingual interface (RU/EN toggle) -->
<h1 class="text-base md:text-2xl font-mono text-terminalGreen whitespace-nowrap overflow-hidden text-ellipsis">
    <span x-text="getTerminalPath()"></span>
</h1>
{% endblock %}

{% block content %}
<script>
    const CAT_STRUCTURE = {{ cat_structure | tojson }};
    const CATEGORIES_DB = {
        {% for cat in categories %}
    "{{ cat.slug }}": "{{ cat.id }}",
        {% endfor %}
    };
    // Reverse map for ID -> Slug
    const ID_TO_SLUG = {};
    for (let k in CATEGORIES_DB) ID_TO_SLUG[CATEGORIES_DB[k]] = k;

    const ITEMS_DATA = {{ items | tojson }};

    function inventoryApp() {
        return {
            // UI State
            showSidebar: false,
            showChat: false,
            currentTab: 'all',
            currentSubTab: null, // slug
            showDetail: false,
            showSubModal: false,
            // Mode: 'add' or 'edit'
            mode: 'add',
            expandedCategory: null, // Slug of expanded category

            // New Subcategory Form
            newSub: {
                name: '',
                categoryId: null,
                categorySlug: '',
                file: null
            },
            iconPreview: null,

            // Edit Subcategory Form
            selectedSubcategorySlug: null,
            showSubEditModal: false,
            editSub: {
                id: null,
                name: '',
                slug: '',
                categoryId: null,
                file: null
            },
            editIconPreview: null,

            // Current Item Data
            currentItem: {
                id: null,
                category: '',
                subcategory: '',
                name: '',
                quantity: 1,
                target_quantity: 10,
                expiry_date: ''
            },

            // Chat State
            chatMessages: [],
            chatInput: '',
            chatLoading: false,

            init() {
                this.resetForm();
            },

            resetForm() {
                this.currentItem = {
                    id: null,
                    category: '',
                    subcategory: '',
                    name: '',
                    quantity: 1,
                    target_quantity: 10,
                    expiry_date: '1970-01-01'
                };
            },

            toggleCategory(slug) {
                if (this.expandedCategory === slug) {
                    this.expandedCategory = null;
                } else {
                    this.expandedCategory = slug;
                }
            },

            selectSubCategory(catId, subSlug) {
                this.currentTab = catId.toString();
                this.currentSubTab = subSlug;
                // Keep sidebar open for easier navigation
            },

            openSubModal(slug) {
                this.newSub = {
                    name: '',
                    categoryId: CATEGORIES_DB[slug],
                    categorySlug: slug,
                    file: null
                };
                this.iconPreview = null;
                this.showSubModal = true;
            },

            handleIconSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.newSub.file = file;
                    // Preview
                    const reader = new FileReader();
                    reader.onload = (e) => this.iconPreview = e.target.result;
                    reader.readAsDataURL(file);
                }
            },

            async submitSubCategory() {
                if (!this.newSub.name) return alert("Name required");

                const formData = new FormData();
                formData.append('name', this.newSub.name);
                formData.append('category_id', this.newSub.categoryId);
                if (this.newSub.file) {
                    formData.append('file', this.newSub.file);
                }

                try {
                    const res = await fetch('/api/subcategories/', {
                        method: 'POST',
                        body: formData
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const txt = await res.json();
                        alert("Error: " + (txt.detail || "Unknown"));
                    }
                } catch (e) {
                    alert("Network Error");
                }
            },

            // Handle subcategory click (single = select, double = edit)
            handleSubcategoryClick(catId, subSlug, subData) {
                if (this.selectedSubcategorySlug === subSlug) {
                    // Double click: open edit modal
                    this.openSubEditModal(catId, subSlug, subData);
                } else {
                    // Single click: select for navigation
                    this.selectSubCategory(catId, subSlug);
                    this.selectedSubcategorySlug = subSlug;
                }
            },

            openSubEditModal(catId, subSlug, subData) {
                this.editSub = {
                    id: subData.id,
                    name: subData.name,
                    slug: subSlug,
                    categoryId: catId,
                    file: null
                };
                this.editIconPreview = subData.icon ? `/static/icons/${subData.icon}` : null;
                this.showSubEditModal = true;
                this.showSidebar = false;
            },

            handleEditIconSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.editSub.file = file;
                    const reader = new FileReader();
                    reader.onload = (e) => this.editIconPreview = e.target.result;
                    reader.readAsDataURL(file);
                }
            },

            async updateSubcategory() {
                if (!this.editSub.name) return alert("Название обязательно");

                const formData = new FormData();
                formData.append('name', this.editSub.name);
                if (this.editSub.file) {
                    formData.append('file', this.editSub.file);
                }

                try {
                    const res = await fetch(`/api/subcategories/${this.editSub.id}`, {
                        method: 'PUT',
                        body: formData
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const txt = await res.json();
                        alert("Ошибка: " + (txt.detail || "Неизвестно"));
                    }
                } catch (e) {
                    alert("Сетевая ошибка");
                }
            },

            async deleteSubcategory() {
                if (!confirm('Удалить эту подкатегорию? Элементы в ней останутся.')) return;

                try {
                    const res = await fetch(`/api/subcategories/${this.editSub.id}`, {
                        method: 'DELETE'
                    });
                    if (res.ok || res.status === 204) {
                        window.location.reload();
                    } else {
                        const txt = await res.json();
                        alert("Ошибка: " + (txt.detail || "Неизвестно"));
                    }
                } catch (e) {
                    alert("Сетевая ошибка");
                }
            },

            getSubcategories(catKey) {
                if (!catKey || !CAT_STRUCTURE[catKey]) return {};
                return CAT_STRUCTURE[catKey].subs;
            },

            getTerminalPath() {
                const user = '{{ user.username if user else "guest" }}';
                let path = `${user}@warehouse_21:~`;

                if (this.currentTab && this.currentTab !== 'all') {
                    const slug = ID_TO_SLUG[this.currentTab];
                    if (slug && CAT_STRUCTURE[slug]) {
                        path += `/${slug}`;

                        if (this.currentSubTab) {
                            path += `/${this.currentSubTab}`;
                        }
                    }
                }

                return path;
            },

            openAddModal() {
                this.mode = 'add';
                this.resetForm();

                // Smart Pre-fill
                if (this.currentTab !== 'all') {
                    // currentTab is ID. Find slug.
                    const slug = ID_TO_SLUG[this.currentTab];
                    if (slug) {
                        this.currentItem.category = slug;
                    }
                    if (this.currentSubTab) {
                        this.currentItem.subcategory = this.currentSubTab;
                    }
                }

                this.showDetail = true;
            },

            openEditModalId(id) {
                const item = ITEMS_DATA.find(i => i.id === id);
                if (item) this.openEditModal(item);
            },

            openEditModal(item) {
                this.mode = 'edit';
                // Find category key by ID
                let catKey = ID_TO_SLUG[item.category_id] || '';

                this.currentItem = {
                    id: item.id,
                    category: catKey,
                    subcategory: item.subcategory,
                    name: item.name,
                    quantity: item.quantity,
                    target_quantity: item.target_quantity || 10,
                    expiry_date: item.expiry_date || '1970-01-01'
                };
                this.showDetail = true;
            },

            adjustQty(delta) {
                let v = parseInt(this.currentItem.quantity) || 0;
                v += delta;
                if (v < 0) v = 0;
                this.currentItem.quantity = v;
            },

            async saveItem() {
                if (!this.currentItem.category) {
                    alert('Category required');
                    return;
                }

                // LOGIC: If Quantity is 0, we treat this as a DELETE operation
                const qty = parseInt(this.currentItem.quantity);
                if (qty === 0) {
                    if (this.mode === 'edit' && this.currentItem.id) {
                        return this.deleteItem(); // Reuse the delete function
                    }
                }

                const catId = parseInt(CATEGORIES_DB[this.currentItem.category]);
                const payload = {
                    name: this.currentItem.name,
                    quantity: qty,
                    target_quantity: parseInt(this.currentItem.target_quantity),
                    subcategory: this.currentItem.subcategory,
                    expiry_date: this.currentItem.expiry_date || null,
                    category_id: catId,
                    icon_type: "pack_generic.png"
                };

                try {
                    let url = '/api/items/';
                    if (this.mode === 'edit') {
                        // Delete old first (lazy update)
                        await fetch(`/api/items/${this.currentItem.id}`, { method: 'DELETE' });
                    }

                    const res = await fetch('/api/items/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        window.location.reload();
                    } else {
                        alert("ERROR SAVING");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Network Error");
                }
            },

            async deleteItem() {
                if (!confirm('DELETE ITEM?')) return;
                const id = parseInt(this.currentItem.id);

                try {
                    const res = await fetch(`/api/items/${id}`, { method: 'DELETE' });

                    if (res.ok) {
                        window.location.reload();
                    } else {
                        const err = await res.text();
                        alert("DELETE FAILED: " + err);
                    }
                } catch (e) {
                    alert("Delete Error: " + e.message);
                }
            },

            async sendChatMessage() {
                if (!this.chatInput.trim()) return;

                const userMsg = this.chatInput;
                this.chatMessages.push({ role: 'user', text: userMsg });
                this.chatInput = '';
                this.chatLoading = true;

                this.$nextTick(() => {
                    const container = document.getElementById('chat-history');
                    if (container) container.scrollTop = container.scrollHeight;
                });

                try {
                    const res = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg, history: this.chatMessages })
                    });
                    const data = await res.json();

                    this.chatMessages.push({ role: 'ai', text: data.response });
                } catch (e) {
                    this.chatMessages.push({ role: 'ai', text: 'CONNECTION ERROR.' });
                } finally {
                    this.chatLoading = false;
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-history');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                    // Reload if item added
                    if (this.chatMessages[this.chatMessages.length - 1].text.includes("ADDED")) {
                        setTimeout(() => window.location.reload(), 1500);
                    }
                }
            }
        }
    }
</script>



<!-- Sidebar (Drawer) -->
<!-- Sidebar (Drawer) - RETRO OS STYLE -->
<div x-show="showSidebar" style="display: none;" class="fixed inset-0 z-[100] flex">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black bg-opacity-90 backdrop-blur-sm" @click="showSidebar = false"
        x-transition.opacity></div>

    <!-- Drawer Content (Retro Border & Shadow) -->
    <div class="relative bg-darkBg border-r-2 border-amber w-[85%] max-w-[300px] h-full shadow-[0_0_50px_rgba(255,176,0,0.5)] flex flex-col p-4 z-[101] transform transition-transform"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full">

        <!-- Sidebar Header (Solid Amber Style) -->
        <div class="flex justify-between items-center mb-8 bg-amber text-black p-2 border-b-2 border-amber">
            <span class="font-bold tracking-widest text-xl">SYS.MENU</span>
            <button @click="showSidebar = false"
                class="text-black hover:text-white hover:bg-black border-2 border-black px-2 font-bold transition-colors">X</button>
        </div>

        <!-- Add Button (Smaller, Neon Blue Square) -->
        {% if user and user.is_admin %}
        <button @click="openAddModal(); showSidebar = false"
            class="w-full border-2 border-neonBlue text-neonBlue font-bold py-2 uppercase tracking-widest hover:bg-white/10 hover:text-white transition-colors shadow-[0_0_10px_#00ccff] mb-4 text-lg flex items-center justify-center gap-4">
            ДОБАВИТЬ
        </button>

        <!-- Divider after Add Button -->
        <div class="h-0.5 bg-amber/30 mb-4"></div>
        {% endif %}

        <!-- Scrollable Categories Container -->
        <div class="flex-1 overflow-y-auto flex flex-col pr-2">
            <!-- Dynamic Categories Accordion -->
            <template x-for="(data, slug) in CAT_STRUCTURE" :key="slug">
                <div class="mb-1">
                    <!-- Parent Category -->
                    <button @click="toggleCategory(slug)"
                        :class="currentTab === data.id.toString() ? 'bg-amber text-black shadow-[0_0_10px_#ffb000]' : 'border border-amber text-amber hover:bg-amber/20'"
                        class="w-full py-3 uppercase font-bold text-lg md:text-xl transition-all text-left px-4 flex items-center justify-between group">
                        <div class="flex items-center gap-2">
                            <span x-text="data.name"></span>
                        </div>
                        <!-- Arrow -->
                        <span x-text="expandedCategory === slug ? '▼' : '▶'" class="text-xs"></span>
                    </button>

                    <!-- Subcategory List (Sub-indent with dashed border line) -->
                    <div x-show="expandedCategory === slug" x-collapse
                        class="border-l-2 border-dashed border-amber/30 ml-4 pl-2 mt-1 flex flex-col gap-1">

                        <!-- Main Category Filter (To see all in this cat) -->
                        <!-- TODO: Add category CRUD functionality (edit/delete categories) -->
                        <button @click="currentTab = data.id.toString(); currentSubTab = null"
                            :class="currentTab === data.id.toString() && !currentSubTab ? 'bg-amber/20 text-white' : 'text-amber/70 hover:bg-amber/10'"
                            class="text-left text-base uppercase py-1 px-2 transition-colors">
                            <span x-text="'> ВСЕ (' + data.name + ')'"></span>
                        </button>

                        <!-- Subs -->
                        <template x-for="(subData, subSlug) in data.subs">
                            <button @click="handleSubcategoryClick(data.id, subSlug, subData)"
                                :class="currentTab === data.id.toString() && currentSubTab === subSlug ? 'bg-amber/20 text-white' : 'text-amber/70 hover:bg-amber/10'"
                                class="text-left text-base uppercase py-1 px-2 transition-colors flex items-center gap-2">
                                <span class="w-1 h-1 bg-amber rounded-full"></span>
                                <span x-text="subData.name"></span>
                            </button>
                        </template>

                        <!-- Add Subcategory Button (Blue) -->
                        {% if user and user.is_admin %}
                        <button @click="openSubModal(slug); showSidebar = false"
                            class="mt-2 w-full border-2 border-neonBlue text-neonBlue text-2xl font-bold py-2 items-center justify-center flex hover:bg-neonBlue hover:text-black transition-colors">
                            +
                        </button>
                        {% endif %}
                    </div>
                </div>
            </template>

            <!-- All Items pushed to bottom (Lifted slightly) -->
            <button @click="currentTab = 'all'; currentSubTab = null"
                :class="currentTab === 'all' ? 'bg-amber text-black shadow-[0_0_10px_#ffb000]' : 'border border-amber text-amber hover:bg-amber/20'"
                class="mt-auto mb-1 w-full py-3 uppercase font-bold text-lg md:text-xl transition-all text-left px-4 flex items-center gap-3">
                ВСЕ ЭЛЕМЕНТЫ
            </button>
        </div>

        <!-- Footer: Shopping List Stub -->
        <div class="mt-auto border-t-2 border-amber pt-6 pb-8">
            <button
                class="w-full border border-gray-600 text-gray-500 py-3 uppercase text-xs cursor-not-allowed border-dashed">
                [ СПИСОК_ПОКУПОК_ВЫКЛ ]
            </button>
        </div>
    </div>
</div>

<!-- Grid -->
<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 pb-20 pt-2">
    {% for item in items %}
    <div x-show="(currentTab === 'all' || currentTab === '{{ item.category_id }}') && (!currentSubTab || currentSubTab === '{{ item.subcategory }}')"
        @click="openEditModalId({{ item.id }})"
        class="aspect-square border-2 border-amber bg-black relative group hover:bg-[#222] transition-colors cursor-pointer overflow-hidden shadow-[0_0_5px_rgba(255,176,0,0.3)]">

        <!-- Icon Full Size -->
        <img src="/static/icons/{{ item.icon_type }}?v=2" class="w-full h-full object-contain p-4"
            onerror="this.src='/static/icons/pack_generic.png'">

        <!-- Quantity Overlay (LARGER FONT) -->
        <div
            class="absolute bottom-0 right-0 bg-amber text-black px-2 py-0 text-3xl font-bold leading-none border-t border-l border-black z-10">
            {{ item.quantity }}
        </div>

        <!-- Name Overlay (LARGER FONT) -->
        <div
            class="absolute top-0 left-0 w-full bg-black bg-opacity-70 text-amber text-lg md:text-xl font-bold px-1 truncate z-10">
            {{ item.name }}
        </div>

        {% if item.expiry_date %}
        <div class="absolute top-8 right-0 text-[10px] text-gray-400 bg-black px-1 border border-gray-800">
            {{ item.expiry_date }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Add Subcategory Modal (Moved out of loop) -->
<div x-show="showSubModal" style="display: none;" class="fixed inset-0 z-[200] flex items-center justify-center p-4"
    x-transition.opacity>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-90 backdrop-blur-sm" @click="showSubModal = false"></div>

    <!-- Window -->
    <div
        class="relative bg-darkBg border-2 border-neonBlue w-full max-w-sm shadow-[0_0_50px_rgba(0,204,255,0.4)] flex flex-col">
        <!-- Header -->
        <div
            class="bg-neonBlue text-black px-2 py-1 font-bold text-sm tracking-widest flex justify-between items-center select-none">
            <span>СОЗДАТЬ ПОДКАТЕГОРИЮ</span>
            <button @click="showSubModal = false"
                class="hover:bg-black hover:text-neonBlue px-1 text-lg font-bold">X</button>
        </div>

        <div class="p-6 flex flex-col gap-4">
            <!-- Info -->
            <div class="text-xs text-neonBlue opacity-70">
                РОДИТЕЛЬСКАЯ КАТЕГОРИЯ: <span x-text="CAT_STRUCTURE[newSub.categorySlug]?.name"
                    class="font-bold text-white"></span>
            </div>

            <!-- Name -->
            <div>
                <label class="text-xs text-neonBlue block mb-1">НАЗВАНИЕ</label>
                <input type="text" x-model="newSub.name" placeholder="Например: Консервы"
                    class="w-full bg-[#111] text-neonBlue border border-neonBlue p-2 focus:outline-none uppercase text-base">
            </div>

            <!-- Icon Upload -->
            <div>
                <label class="text-xs text-neonBlue block mb-1">ЗАГРУЗИТЬ ИКОНКУ (опционально)</label>
                <div
                    class="relative border-2 border-dashed border-neonBlue p-4 text-center cursor-pointer hover:bg-neonBlue/10 transition-colors">
                    <input type="file" @change="handleIconSelect" accept="image/*"
                        class="absolute inset-0 opacity-0 cursor-pointer">
                    <span class="text-sm text-neonBlue" x-show="!iconPreview">НАЖМИТЕ ДЛЯ ЗАГРУЗКИ</span>

                    <div x-show="iconPreview" class="flex justify-center">
                        <img :src="iconPreview" class="h-16 w-16 object-contain">
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <button @click="submitSubCategory()"
                class="mt-2 w-full bg-neonBlue text-black font-bold py-2 text-base uppercase tracking-widest hover:bg-white hover:text-black transition-colors">
                СОЗДАТЬ
            </button>
        </div>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<!-- TODO: Унифицировать цветовую тему модалок (currently inconsistent) -->
<div x-show="showSubEditModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition.opacity>
    <!-- Backdrop -->
    <div @click="showSubEditModal = false" class="absolute inset-0 bg-black bg-opacity-80"></div>

    <!-- Modal Card -->
    <div
        class="relative bg-darkBg border-2 border-neonBlue w-full max-w-sm shadow-[0_0_50px_rgba(0,204,255,0.5)] flex flex-col animate-scale-in">

        <!-- Header -->
        <div
            class="bg-neonBlue text-black px-2 py-1 font-bold text-base tracking-widest flex justify-between items-center select-none">
            <span>РЕДАКТИРОВАТЬ ПОДКАТЕГОРИЮ</span>
            <button @click="showSubEditModal = false"
                class="hover:bg-black hover:text-neonBlue px-1 text-lg font-bold">X</button>
        </div>

        <div class="p-6 flex flex-col gap-4">
            <!-- Name -->
            <div>
                <label class="text-xs text-neonBlue block mb-1">НАЗВАНИЕ</label>
                <input type="text" x-model="editSub.name" placeholder="Название подкатегории"
                    class="w-full bg-[#111] text-neonBlue border border-neonBlue p-2 focus:outline-none uppercase text-base">
            </div>

            <!-- Icon Upload -->
            <div>
                <label class="text-xs text-neonBlue block mb-1">СМЕНИТЬ ИКОНКУ (опционально)</label>
                <div
                    class="relative border-2 border-dashed border-neonBlue p-4 text-center cursor-pointer hover:bg-neonBlue/10 transition-colors">
                    <input type="file" @change="handleEditIconSelect" accept="image/*"
                        class="absolute inset-0 opacity-0 cursor-pointer">
                    <span class="text-sm text-neonBlue" x-show="!editIconPreview">НАЖМИТЕ ДЛЯ ЗАГРУЗКИ</span>

                    <div x-show="editIconPreview" class="flex justify-center">
                        <img :src="editIconPreview" class="h-16 w-16 object-contain">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col gap-2">
                <!-- Save -->
                <button @click="updateSubcategory()"
                    class="w-full bg-amber text-black font-bold py-2 text-base uppercase tracking-widest hover:bg-white hover:text-black transition-colors">
                    СОХРАНИТЬ
                </button>

                <!-- Delete -->
                <button @click="deleteSubcategory()"
                    class="w-full border-2 border-red-600 text-red-600 font-bold py-2 text-base uppercase tracking-widest hover:bg-red-600 hover:text-black transition-colors">
                    УДАЛИТЬ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detail/Edit Modal -->
<div x-show="showDetail" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center p-4"
    x-transition.opacity>

    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-90 backdrop-blur-sm" @click="showDetail = false"></div>

    <!-- Modal Card (Retro OS Style - Updated Colors) -->
    <div
        class="relative bg-darkBg border-2 border-amber w-full max-w-sm shadow-[0_0_50px_rgba(255,176,0,0.5)] flex flex-col animate-scale-in">

        <!-- Window Header -->
        <div
            class="bg-amber text-black px-2 py-1 font-bold text-sm tracking-widest flex justify-between items-center select-none">
            <span x-text="mode === 'add' ? 'ДОБАВИТЬ ЭЛЕМЕНТ' : 'РЕДАКТИРОВАТЬ'"></span>
            <button @click="showDetail = false"
                class="hover:bg-black hover:text-amber px-1 text-lg font-bold">X</button>
        </div>

        <div class="p-6 flex flex-col gap-6">
            <!-- Name Field (Neon Blue) -->
            <div class="border-b border-neonBlue">
                <label class="text-xs text-neonBlue block mb-1 opacity-70">НАЗВАНИЕ</label>
                <input type="text" x-model="currentItem.name"
                    class="w-full bg-transparent text-neonBlue text-xl font-bold focus:outline-none placeholder-blue-900 uppercase tracking-wider">
            </div>

            <!-- Dropdowns -->
            <div class="flex gap-4">
                <div class="w-1/2">
                    <label class="text-xs text-amber block mb-1 opacity-70">КАТЕГОРИЯ</label>
                    <select x-model="currentItem.category"
                        class="w-full bg-[#222] border border-amber text-amber text-sm p-2 focus:outline-none">
                        <option value="">-- ВЫБЕРИТЕ --</option>
                        {% for key, val in cat_structure.items() %}
                        <option value="{{ key }}">{{ val.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="w-1/2">
                    <label class="text-xs text-amber block mb-1 opacity-70">ТИП</label>
                    <select x-model="currentItem.subcategory"
                        class="w-full bg-[#222] border border-amber text-amber text-sm p-2 focus:outline-none">
                        <template x-if="currentItem.category">
                            <template x-for="(subData, key) in getSubcategories(currentItem.category)">
                                <option :value="key" x-text="subData.name"></option>
                            </template>
                        </template>
                    </select>
                </div>
            </div>

            <!-- Expiry (Neon Blue) -->
            <div>
                <label class="text-xs text-neonBlue block mb-1 opacity-70">СРОК ГОДНОСТИ</label>
                <input type="date" x-model="currentItem.expiry_date"
                    class="w-full bg-[#222] text-neonBlue p-2 border border-neonBlue text-base uppercase">
            </div>

            <!-- Counter (Rectangular Outline Buttons << >>) -->
            <div>
                <label class="text-xs text-white block mb-2 opacity-50 text-center">КОЛИЧЕСТВО</label>
                <div class="flex items-center justify-center gap-4">
                    <!-- Decrement << -->
                    <button @click="adjustQty(-1)"
                        class="w-16 h-10 border-2 border-neonBlue text-neonBlue font-bold text-lg hover:bg-neonBlue hover:text-black transition-colors flex items-center justify-center">
                        &lt;&lt;
                    </button>

                    <div class="text-4xl font-mono w-20 text-center text-white" x-text="currentItem.quantity"></div>

                    <!-- Increment >> -->
                    <button @click="adjustQty(1)"
                        class="w-16 h-10 border-2 border-neonBlue text-neonBlue font-bold text-lg hover:bg-neonBlue hover:text-black transition-colors flex items-center justify-center">
                        &gt;&gt;
                    </button>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col gap-3 mt-4">
                <!-- Save (Amber) -->
                <button @click="saveItem()"
                    class="w-full bg-amber text-black font-bold py-3 text-base uppercase tracking-widest hover:bg-white transition-colors shadow-[0_0_15px_#ffb000]">
                    СОХРАНИТЬ
                </button>

                <!-- Delete (Red Outline) -->
                <template x-if="mode === 'edit'">
                    <button @click="deleteItem()"
                        class="w-full border-2 border-[#ff3300] text-[#ff3300] bg-transparent font-bold text-sm py-2 uppercase hover:bg-[#ff3300] hover:text-black transition-colors">
                        УДАЛИТЬ
                    </button>
                </template>
            </div>
        </div>
    </div>
</div>

<!-- Alpine JS -->
<script src="//unpkg.com/alpinejs" defer></script>
{% endblock %}